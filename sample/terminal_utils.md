# ターミナルのキーボード制御

C言語のターミナルゲームで使うライブラリ

```c
#include "terminal_utils.h"
#include <stdio.h>
#include <termios.h>
#include <unistd.h>
#include <fcntl.h>

struct termios orig_termios;

void disableEcho() {
    struct termios new_termios;

    // 現在の端末設定を保存
    tcgetattr(STDIN_FILENO, &orig_termios);
    new_termios = orig_termios;

    // エコーをオフにする
    new_termios.c_lflag &= ~(ICANON | ECHO);

    // 即座に適用
    tcsetattr(STDIN_FILENO, TCSANOW, &new_termios);
}

void restoreTerminal() {
    // 元の端末設定に戻す
    tcsetattr(STDIN_FILENO, TCSANOW, &orig_termios);
}


// キーボードが押されたかどうかを非ブロッキングで確認
int kbhit() {
    int ch;
    int oldf;

    // 標準入力のフラグを取得
    oldf = fcntl(STDIN_FILENO, F_GETFL, 0);
    // 一時的に非ブロッキングモードに設定
    fcntl(STDIN_FILENO, F_SETFL, oldf | O_NONBLOCK);

    // 入力を１文字読み取れるか試みる
    ch = getchar();

    // 標準入力の設定を元に戻す
    fcntl(STDIN_FILENO, F_SETFL, oldf);

    // 入力がない場合（EOFが返される）、0を返す
    if(ch != EOF) {
        ungetc(ch, stdin);
        return 1;   // キー入力があった場合
    }

    return 0; // キー入力がない場合
}
```

このコードはコンソールゲームで使用できるキーボード入力を処理するためのライブラリの一部です。主な機能は以下の通りです：

1. `disableEcho()`:
   - ターミナルのエコー機能を無効にします。
   - キーを押しても画面に表示されなくなります。
   - カノニカルモードも無効にし、入力を即座に受け取れるようにします。

2. `restoreTerminal()`:
   - ターミナルの設定を元の状態に戻します。

3. `kbhit()`:
   - キー入力があるかどうかを非ブロッキングで確認します。
   - 入力があれば1を、なければ0を返します。

このライブラリは、UNIXシステムのターミナル制御に関する低レベルの操作を行っています。`termios.h`や`fcntl.h`などのヘッダーファイルを使用し、ターミナルの設定を変更したり、ノンブロッキングI/Oを実現したりしています。

これらの関数を使うことで、ゲームの開発者は以下のようなことが可能になります：

- キー入力をリアルタイムで検出する
- キーを押しても画面に表示されないようにする（例：パスワード入力など）
- ゲームループ内で継続的にキー入力をチェックする

このコードを使用して、より応答性の高いコンソールベースのゲームやアプリケーションを作成することができます。


### カノニカルモード

カノニカルモード（Canonical mode）は、ターミナル入力の処理方法の一つです。これについて詳しく説明します：

1. 定義:
   カノニカルモード（別名：行編集モード）は、入力を行単位で処理するモードです。

2. 動作:
   - ユーザーが入力を完了し、Enter キーを押すまで、入力は処理されません。
   - この間、ユーザーは backspace などを使って入力を編集できます。

3. 特徴:
   - 入力の編集が可能
   - 行バッファリングを使用
   - 特定の制御文字（例：Ctrl+C for SIGINT）が特別な意味を持つ

4. 非カノニカルモードとの比較:
   - 非カノニカルモードでは、キー入力が即座に処理されます。
   - ゲームやリアルタイムアプリケーションでは非カノニカルモードが好まれます。

5. コード内での処理:
   提供されたコードの `disableEcho()` 関数で、以下の行によってカノニカルモードが無効化されています：
   ```c
   new_termios.c_lflag &= ~(ICANON | ECHO);
   ```
   ここで `ICANON` フラグを外すことで、非カノニカルモードに切り替えています。

6. 利点と欠点:
   - 利点：テキスト入力や対話型シェルに適している
   - 欠点：リアルタイム入力が必要なアプリケーションには不向き

カノニカルモードはテキスト処理に適していますが、ゲームのような即時反応が必要なアプリケーションでは、非カノニカルモードを使用することが一般的です。


1. カノニカルモード（デフォルト）:
   - チャットアプリ
   - コマンドラインインターフェース
   - テキストエディタ
   - メール作成ソフト

   これらのアプリケーションでは、ユーザーが入力を編集し、確認してから送信したいケースが多いため、カノニカルモードが適しています。

2. 非カノニカルモード:
   - アクションゲーム
   - リアルタイムストラテジーゲーム
   - テキストベースの高速タイピングゲーム
   - システムモニタリングツール（リアルタイム更新）

   これらのアプリケーションでは、キー入力に対する即時の反応が必要なため、非カノニカルモードが適しています。

非カノニカルモードを使用する場合、開発者は以下の点に注意する必要があります：

1. 入力のバッファリングと処理を自前で実装する必要がある
2. 特殊キー（矢印キーなど）の処理が複雑になる可能性がある
3. プログラム終了時に適切にターミナル設定を元に戻す必要がある（提供されたコードの `restoreTerminal()` 関数がこれを行っています）

アプリケーションの要件に応じて適切なモードを選択し、必要に応じて切り替えることで、より良いユーザー体験を提供できます。


### ncurses

ncursesライブラリは基本的に非カノニカルモードで動作します。

1. ncursesの概要:
   - テキストベースのユーザーインターフェースを作成するためのライブラリです。
   - 端末の制御や画面操作を抽象化し、高度な機能を提供します。

2. 動作モード:
   - デフォルトで非カノニカルモードを使用します。
   - `cbreak()` モードを使用し、入力を即座に処理します。

3. 主な特徴:
   - キー入力のリアルタイム処理
   - 画面の任意の位置にテキストを表示
   - ウィンドウ、パネル、メニューの作成
   - 色やスタイルの制御

4. 利点:
   - 低レベルのターミナル制御を抽象化
   - クロスプラットフォーム対応
   - 豊富な機能セット

5. 使用例:
   - テキストベースのゲーム
   - システム管理ツール
   - テキストエディタ

6. 他のモードとの比較:
   - raw()モード: さらに低レベルな制御が可能（Ctrl+C等も捕捉）
   - noraw()モード: 一部の特殊キーを処理

ncursesを使用すると、先ほど提示されたコードのような低レベルの端末制御を直接扱う必要がなくなり、より高度な機能を簡単に実装できます。ただし、ncursesは非カノニカルモードを基本としているため、標準的なテキスト入力処理とは異なる挙動になることに注意が必要です。


### 


